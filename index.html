<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<style>
    body {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
        font-family: 'Microsoft JhengHei', Arial, sans-serif;
    }
    #main {
        width: 100%;
        height: 100vh;
    }
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 24px;
        z-index: 1000;
    }
</style>
<body>
    <div id="loading" class="loading">數據加載中，請稍候...</div>
    <div id="main"></div>
    <script>
    // 初始化圖表
    var chartDom = document.getElementById("main");
    var myChart = echarts.init(chartDom);
    
    // 城市坐標數據
    var geoCoordMap = {
        '高雄市': [120.63397253230777, 22.96510807924244],
        '台中市': [120.88303557156821, 24.22976722061671],
        '新北市': [121.56233791721156, 24.912096428815047],
        '屏東縣': [120.644845, 22.542893],
        '台南市': [120.32621160351262, 23.167583572934454],
        '桃園市': [121.22942515940727, 24.908913064300542],
        '花蓮縣': [121.427729, 23.783188],
        '台北市': [121.51185772382642, 25.02771294110296],
        '台東縣': [121.054566, 22.872413],
        '彰化縣': [120.472066, 23.990594],
        '雲林縣': [120.37140692500215, 23.7220205712259],
        '南投縣': [120.98222282177481, 23.862057901460222],
        '基隆市': [121.7090375475519, 25.115942332151228],
        '新竹縣': [121.15845951265977, 24.676877878638546],
        '苗栗縣': [120.92111693825872, 24.493472949565177],
        '嘉義縣': [120.6384686106581, 23.49204553894098],
        '宜蘭縣': [121.6827471803587, 24.55390323104749],
        '嘉義市': [120.44380244177937, 23.49123253156815],
        '新竹市': [120.97063102545773, 24.807783800541078],
        '澎湖縣': [119.61676029530447, 23.58029482756267],
        '金門縣': [118.3825301, 24.4367934],
        '連江縣': [119.9285309, 26.1505556]
    };

    // 從Excel讀取數據
    function loadExcelData() {
        // 使用絕對路徑確保無論在哪個目錄下都能找到文件
        const excelPath = window.location.href.includes('github.io') ? 
            'https://markluoai.github.io/Physicalbank/data.xlsx' : 'data.xlsx';
            
        fetch(excelPath)
            .then(response => {
                if (!response.ok) {
                    throw new Error('網絡响应不正常');
                }
                return response.arrayBuffer();
            })
            .then(buffer => {
                // 解析Excel文件
                const data = new Uint8Array(buffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // 獲取第一個工作表
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                // 將工作表轉換為JSON
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                // 處理數據並更新圖表
                processData(jsonData);
                
                // 隱藏加載動畫
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('加載Excel文件時出錯:', error);
                document.getElementById('loading').textContent = '加載數據失敗，請刷新頁面重試';
            });
    }

    // 處理數據並更新圖表
    function processData(data) {
        if (!data || data.length < 2) {
            console.error('Excel數據為空或格式不正確');
            return;
        }
        
        // 示例：將數據轉換為ECharts所需的格式
        const chartData = [];
        let maxValue = 0;
        
        // 跳過表頭行，從第二行開始處理
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (row && row.length >= 2) {  // 確保行有效且有足夠的列
                const city = String(row[0]).trim();
                const value = parseFloat(row[1]) || 0;
                if (city && geoCoordMap[city]) {
                    maxValue = Math.max(maxValue, value);
                    chartData.push({
                        name: city,
                        value: geoCoordMap[city].concat([value])
                    });
                }
            }
        }
        
        // 更新圖表配置
        updateChart(chartData, maxValue);
    }

    // 更新圖表
    function updateChart(chartData, maxValue) {
        const option = {
            title: {
                text: '實物銀行服務數據統計',
                left: 'center',
                textStyle: {
                    color: '#fff',
                    fontSize: 20
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.seriesType === 'scatter') {
                        return `${params.name}<br/>數值: ${params.value[2]}`;
                    }
                    return params.name;
                }
            },
            visualMap: {
                min: 0,
                max: maxValue,
                text: ['高', '低'],
                realtime: false,
                calculable: true,
                inRange: {
                    color: ['#50a3ba', '#eac736', '#d94e5d']
                },
                textStyle: {
                    color: '#fff'
                }
            },
            geo: {
                map: '台灣',
                roam: true,
                label: {
                    show: true,
                    color: '#fff',
                    fontSize: 12
                },
                itemStyle: {
                    areaColor: '#1E90FF',
                    borderColor: '#4ab2e5',
                    borderWidth: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)',
                    shadowBlur: 10
                },
                emphasis: {
                    label: {
                        color: '#fff',
                        fontWeight: 'bold'
                    },
                    itemStyle: {
                        areaColor: '#2B91B7'
                    }
                }
            },
            series: [{
                name: '數據',
                type: 'scatter',
                coordinateSystem: 'geo',
                data: chartData,
                symbolSize: function(val) {
                    // 根據數值大小調整點的大小
                    return Math.max(8, Math.min(val[2] / (maxValue / 20), 40));
                },
                encode: {
                    value: 2
                },
                label: {
                    formatter: '{b}',
                    position: 'right',
                    show: false
                },
                itemStyle: {
                    color: '#ddb926',
                    shadowBlur: 10,
                    shadowColor: 'rgba(255, 255, 255, 0.5)'
                },
                emphasis: {
                    label: {
                        show: true
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                }
            }]
        };
        
        myChart.setOption(option, true);
        
        // 窗口大小改變時重新調整圖表大小
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }

    // 頁面加載完成後執行
    document.addEventListener('DOMContentLoaded', function() {
        // 註冊台灣地圖
        $.get('https://slimmay.github.io/storeTW/twCounty2010.json')
            .done(function(taiwanJson) {
                echarts.registerMap('台灣', taiwanJson);
                // 加載Excel數據
                loadExcelData();
            })
            .fail(function(error) {
                console.error('加載地圖數據失敗:', error);
                document.getElementById('loading').textContent = '加載地圖失敗，請檢查網絡連接後刷新頁面';
            });
    });
</script>
</body>
</html>
