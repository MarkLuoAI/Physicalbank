<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <style>
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
        }
        #main {
            width: 100%;
            height: 100vh;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">資料載入中...</div>
    <div id="main"></div>

    <script>
        // 全局變量
        var chartDom, myChart, optionXyMap01;
        var currentPinType = 0;
        var pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];
        var colors = [
            "#ff0076", "#F46E36", "#04B9FF", "#5DBD32", "#FFC809", 
            "#1DE9B6", "#BDA29A", "#6E7074", "#546570", "#C4CCD3"
        ];
        var webAppUrl = "https://script.google.com/macros/s/AKfycbxoNLAmoFw_Jng2iFoFm_9BcUU-hvaIZOQG191rzu-nWZFqWJ-Jb2N59z1wV5OzY3hA/exec";
        
        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchData();
        });

        // 初始化圖表
        function initChart() {
            chartDom = document.getElementById("main");
            myChart = echarts.init(chartDom);
            addControlButtons();
        }

        // 添加控制按鈕
        function addControlButtons() {
            var buttonContainer = document.createElement('div');
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.left = '10px';
            buttonContainer.style.bottom = '50px';
            buttonContainer.style.zIndex = '999';

            for (var i = 0; i < pinTypeTitles.length; i++) {
                var button = document.createElement('button');
                button.innerHTML = pinTypeTitles[i];
                button.style.margin = '5px';
                button.style.padding = '5px 10px';
                button.style.backgroundColor = '#2B91B7';
                button.style.color = '#fff';
                button.style.border = 'none';
                button.style.borderRadius = '3px';
                button.style.cursor = 'pointer';
                button.dataset.type = i;
                
                button.addEventListener('click', function() {
                    switchPinType(parseInt(this.dataset.type));
                });
                
                buttonContainer.appendChild(button);
            }

            document.body.appendChild(buttonContainer);
        }

        // 切換圖釘類型
        function switchPinType(type) {
            if (currentPinType !== type) {
                currentPinType = type;
                renderChart();
            }
        }

        // 從 Google Apps Script 獲取數據
        async function fetchData() {
            try {
                const response = await fetch(webAppUrl);
                const result = await response.json();
                
                // 處理數據
                processData(result);
                
                // 加載地圖並渲染圖表
                loadMapAndRender();
                
            } catch (error) {
                console.error('獲取數據失敗:', error);
                document.getElementById('loading').textContent = '數據加載失敗，請刷新頁面重試';
            }
        }

        // 處理數據
        function processData(data) {
            // 從數據中提取所有唯一的年份
            const years = [];
            const yearSet = new Set();
            
            // 收集所有年份
            data.forEach(item => {
                const year = item.年份 || item.year;
                if (year && !yearSet.has(year)) {
                    yearSet.add(year);
                    years.push(year.toString());
                }
            });
            
            // 按年份排序
            years.sort();
            
            // 初始化數據結構
            const geoCoordMap = {
                '臺北市': [121.5654, 25.0330],
                '新北市': [121.4657, 25.0126],
                '桃園市': [121.3012, 24.9936],
                '臺中市': [120.6736, 24.1477],
                '臺南市': [120.2130, 22.9919],
                '高雄市': [120.3014, 22.6273],
                '基隆市': [121.7415, 25.1276],
                '新竹市': [120.9647, 24.8036],
                '嘉義市': [120.4470, 23.4801],
                '新竹縣': [121.1252, 24.7033],
                '苗栗縣': [120.9417, 24.5651],
                '彰化縣': [120.5350, 23.9929],
                '南投縣': [120.9876, 23.8388],
                '雲林縣': [120.5272, 23.6960],
                '嘉義縣': [120.3000, 23.3000],
                '屏東縣': [120.4879, 22.6822],
                '宜蘭縣': [121.7377, 24.7021],
                '花蓮縣': [121.3014, 23.8298],
                '臺東縣': [121.0711, 22.7566],
                '澎湖縣': [119.5605, 23.5655],
                '金門縣': [118.3189, 24.4368],
                '連江縣': [119.9349, 26.1507]
            };
            
            window.appData = {
                geoCoordMap: geoCoordMap,
                years: years,
                data: {}
            };

            // 初始化每年的數據結構
            years.forEach(year => {
                window.appData.data[year] = {
                    d: {}, // 核定金額
                    A: {}, // 受益戶數
                    B: {}, // 受益人次
                    C: {}  // 受益同住人
                };
                
                // 初始化每個城市的默認值
                Object.keys(geoCoordMap).forEach(city => {
                    window.appData.data[year].d[city] = 0;
                    window.appData.data[year].A[city] = 0;
                    window.appData.data[year].B[city] = 0;
                    window.appData.data[year].C[city] = 0;
                });
            });

            // 填充數據
            data.forEach(item => {
                const year = (item.年份 || item.year).toString();
                const city = item.縣市 || item.city;
                
                if (window.appData.data[year] && city) {
                    window.appData.data[year].d[city] = parseInt(item.核定金額 || item.amount || 0) || 0;
                    window.appData.data[year].A[city] = parseInt(item.受益戶數 || item.households || 0) || 0;
                    window.appData.data[year].B[city] = parseInt(item.受益人次 || item.people || 0) || 0;
                    window.appData.data[year].C[city] = parseInt(item.受益同住人 || item.cohabitants || 0) || 0;
                }
            });
            
            console.log('Processed data:', window.appData);
        }

        // 加載地圖並渲染圖表
        function loadMapAndRender() {
            const mapUrl = "https://slimMay.github.io/storeTW/twCounty2010.json";
            
            fetch(mapUrl)
                .then(response => response.json())
                .then(geoJson => {
                    echarts.registerMap('TW', geoJson);
                    renderChart();
                })
                .catch(error => {
                    console.error('加載地圖失敗:', error);
                    document.getElementById('loading').textContent = '地圖加載失敗，請檢查網絡連接';
                });
        }

        // 渲染圖表
        function renderChart() {
            const data = window.appData;
            const years = data.years;
            const geoCoordMap = data.geoCoordMap;
            
            // 準備數據
            const mapData = [];
            const pinData = [[], [], []]; // 三種類型的圖釘數據
            const totalAmounts = {};
            const AtotalAmounts = {};
            
            // 處理每年的數據
            years.forEach((year, yearIndex) => {
                const yearData = data.data[year];
                
                // 計算總額
                totalAmounts[year] = Object.values(yearData.d).reduce((a, b) => a + (parseInt(b) || 0), 0);
                AtotalAmounts[year] = Object.values(yearData.A).reduce((a, b) => a + (parseInt(b) || 0), 0);
                
                // 準備地圖和圖釘數據
                const mapYearData = [];
                const pinYearData = [[], [], []];
                
                // 為每個城市添加數據
                Object.keys(geoCoordMap).forEach(city => {
                    // 地圖數據
                    mapYearData.push({
                        name: city,
                        value: parseInt(yearData.d[city]) || 0
                    });
                    
                    // 圖釘數據 (三種類型)
                    pinYearData[0].push({
                        name: city,
                        value: parseInt(yearData.A[city]) || 0
                    });
                    
                    pinYearData[1].push({
                        name: city,
                        value: parseInt(yearData.B[city]) || 0
                    });
                    
                    pinYearData[2].push({
                        name: city,
                        value: parseInt(yearData.C[city]) || 0
                    });
                });
                
                // 排序地圖數據
                mapYearData.sort((a, b) => a.value - b.value);
                mapData.push(mapYearData);
                
                // 排序圖釘數據
                pinYearData.forEach((typeData, typeIndex) => {
                    pinData[typeIndex].push([...typeData].sort((a, b) => a.value - b.value));
                });
            });
            
            // 準備類別數據 (用於柱狀圖)
            const categoryData = mapData[0].map(item => item.name);
            
            // 準備圖表選項
            optionXyMap01 = {
                timeline: {
                    data: years,
                    axisType: 'category',
                    autoPlay: true,
                    playInterval: 3000,
                    left: '10%',
                    right: '10%',
                    bottom: '3%',
                    width: '80%',
                    label: {
                        normal: {
                            textStyle: {
                                color: '#ddd',
                                fontSize: 15
                            }
                        },
                        emphasis: {
                            textStyle: {
                                color: '#fff',
                                fontSize: 20
                            }
                        }
                    },
                    symbolSize: 18,
                    lineStyle: {
                        color: '#555'
                    },
                    checkpointStyle: {
                        borderColor: '#777',
                        borderWidth: 2
                    },
                    controlStyle: {
                        showNextBtn: true,
                        showPrevBtn: true,
                        normal: {
                            color: '#666',
                            borderColor: '#666'
                        },
                        emphasis: {
                            color: '#aaa',
                            borderColor: '#aaa'
                        }
                    }
                },
                baseOption: {
                    animation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicInOut',
                    animationDurationUpdate: 1000,
                    animationEasingUpdate: 'cubicInOut',
                    grid: {
                        right: '10%',
                        top: '11%',
                        bottom: '10%',
                        width: '20%'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: {
                                color: 'rgba(150,150,150,0.1)'
                            }
                        }
                    },
                    geo: {
                        show: true,
                        map: 'TW',
                        layoutCenter: ['40%', '48%'],
                        roam: true,
                        layoutSize: '111%',
                        zoom: 1,
                        aspectScale: 1,
                        center: [121, 23.5],
                        label: {
                            emphasis: {
                                show: false
                            }
                        },
                        itemStyle: {
                            normal: {
                                borderColor: 'rgba(147, 235, 248, 1)',
                                borderWidth: 1,
                                areaColor: {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.8,
                                    colorStops: [{
                                        offset: 0,
                                        color: 'rgba(147, 235, 248, 0)'
                                    }, {
                                        offset: 1,
                                        color: 'rgba(147, 235, 248, .2)'
                                    }],
                                    globalCoord: false
                                },
                                shadowColor: 'rgba(128, 217, 248, 1)',
                                shadowOffsetX: -2,
                                shadowOffsetY: 2,
                                shadowBlur: 10
                            },
                            emphasis: {
                                areaColor: '#389BB7',
                                borderWidth: 0
                            }
                        }
                    }
                },
                options: []
            };

            // 為每一年添加選項
            years.forEach((year, yearIndex) => {
                const formattedAmount = totalAmounts[year].toLocaleString();
                const AformattedAmount = AtotalAmounts[year].toLocaleString();
                
                // 轉換為地圖坐標
                const convertData = (data) => {
                    return data
                        .filter(item => item.value > 0)
                        .map(item => ({
                            name: item.name,
                            value: [...(geoCoordMap[item.name] || []), item.value]
                        }));
                };

                optionXyMap01.options.push({
                    title: [
                        {
                            text: year + ' 實物銀行 服務數據統計',
                            left: '18%',
                            top: '2%',
                            textStyle: {
                                color: '#fff',
                                fontSize: 32
                            }
                        },
                        {
                            id: 'statistic',
                            text: year + " 核定金額 總計 :",
                            left: '70%',
                            top: '4%',
                            textStyle: {
                                color: '#fff',
                                fontSize: 26
                            }
                        },
                        {
                            id: 'totalAmount',
                            text: "$ " + formattedAmount,
                            left: '81%',
                            top: '4%',
                            textStyle: {
                                color: '#FFC809',
                                fontSize: 30
                            }
                        },
                        {
                            id: 'pinType',
                            text: pinTypeTitles[currentPinType] + " 總計",
                            left: '20%',
                            top: '11.5%',
                            textStyle: {
                                color: colors[currentPinType],
                                fontSize: 26
                            }
                        },
                        {
                            id: 'pinTypeAmount-A',
                            text: AformattedAmount + "戶",
                            left: '20%',
                            top: '15%',
                            textStyle: {
                                color: colors[currentPinType],
                                fontSize: 30
                            }
                        }
                    ],
                    xAxis: {
                        type: 'value',
                        scale: true,
                        position: 'top',
                        min: 0,
                        boundaryGap: false,
                        splitLine: {
                            show: false
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        },
                        axisLabel: {
                            margin: 2,
                            textStyle: {
                                color: '#aaa'
                            }
                        }
                    },
                    yAxis: {
                        type: 'category',
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        axisTick: {
                            show: false,
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        axisLabel: {
                            interval: 0,
                            textStyle: {
                                color: '#ddd'
                            }
                        },
                        data: categoryData
                    },
                    series: [
                        {
                            // 地圖底圖
                            type: 'map',
                            map: 'TW',
                            geoIndex: 0,
                            aspectScale: 0.75,
                            showLegendSymbol: false,
                            label: {
                                normal: {
                                    show: false
                                },
                                emphasis: {
                                    show: false,
                                    textStyle: {
                                        color: '#fff'
                                    }
                                }
                            },
                            roam: true,
                            itemStyle: {
                                normal: {
                                    areaColor: '#031525',
                                    borderColor: '#FFFFFF',
                                },
                                emphasis: {
                                    areaColor: '#2B91B7'
                                }
                            },
                            animation: false,
                            data: mapData[yearIndex]
                        },
                        {
                            // 核定金額氣泡
                            name: '核定金額',
                            type: 'effectScatter',
                            coordinateSystem: 'geo',
                            data: convertData([...mapData[yearIndex]].sort((a, b) => b.value - a.value)),
                            symbolSize: function(val) {
                                return Math.sqrt(val[2]) / 40;
                            },
                            showEffectOn: 'render',
                            rippleEffect: {
                                brushType: 'stroke'
                            },
                            hoverAnimation: true,
                            itemStyle: {
                                normal: {
                                    color: '#FFC809',
                                    shadowBlur: 5,
                                    shadowColor: '#FFC809'
                                }
                            },
                            zlevel: 1
                        },
                        {
                            // 圖釘數據
                            name: pinTypeTitles[currentPinType],
                            type: 'scatter',
                            coordinateSystem: 'geo',
                            symbol: 'pin',
                            data: convertData([...pinData[currentPinType][yearIndex]].sort((a, b) => b.value - a.value)),
                            symbolSize: function(val) {
                                return Math.sqrt(val[2]) * 2.6;
                            },
                            label: {
                                normal: {
                                    formatter: function(params) {
                                        return params.value[2];
                                    },
                                    show: true,
                                    textStyle: {
                                        color: '#fff',
                                        fontSize: 15
                                    }
                                }
                            },
                            itemStyle: {
                                normal: {
                                    color: colors[currentPinType],
                                    shadowBlur: 10,
                                    shadowColor: colors[currentPinType]
                                }
                            },
                            zlevel: 2
                        },
                        {
                            // 右側柱狀圖
                            zlevel: 1.5,
                            type: 'bar',
                            symbol: 'none',
                            itemStyle: {
                                normal: {
                                    color: '#FFC809'
                                }
                            },
                            data: mapData[yearIndex].map(item => item.value)
                        }
                    ]
                });
            });
            
            // 設置圖表選項
            myChart.setOption(optionXyMap01);
            
            // 隱藏加載動畫
            document.getElementById('loading').style.display = 'none';
            
            // 添加窗口大小調整監聽器
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
    </script>
</body>
</html>
