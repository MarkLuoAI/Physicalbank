<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<style>
    body {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
  font-family: 'Montserrat', sans-serif;
}
</style>
<body>
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <h2>數據載入中，請稍候...</h2>
    </div>
    <div id="main" style="width: 100%; height: 100vh;"></div>
    <script>
    // 替換為你的 Google Apps Script 網址
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-SSHDSGrmCV_ywvlXgrZelswb3mI80MNiddDAaibJ4qKfLPoTQ8BmPcXU9xhvyTrC/exec';
    
    // 全域變數
    let chartDom, myChart, option, optionXyMap01;
    const uploadedDataURL = "https://slimMay.github.io/storeTW/twCounty2010.json";
    
    // 載入數據
    async function loadData() {
        try {
            // 顯示載入動畫
            document.getElementById('loading').style.display = 'flex';
            
            // 檢查是否在本地環境
            if (window.location.protocol === 'file:') {
                console.warn('檢測到本地環境，可能會有 CORS 限制。建議部署到網頁伺服器上使用。');
            }
            
            // 從 Google Sheets 載入數據
            const response = await fetch(GOOGLE_SCRIPT_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            // 處理數據並初始化圖表
            processData(data);
            initChart();
            
            // 隱藏載入動畫
            document.getElementById('loading').style.display = 'none';
            
        } catch (error) {
            console.error('載入數據時發生錯誤:', error);
            document.getElementById('loading').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2>數據載入失敗</h2>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2B91B7; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        重新載入
                    </button>
                </div>`;
        }
    }
    
    // 處理從 Google Sheets 載入的數據
    function processData(data) {
        // 清空或初始化數據結構
        window.geoCoordMap = {};
        window.d1 = window.d2 = window.d3 = window.d4 = window.d5 = window.d6 = window.d7 = window.d8 = {};
        window.A1 = window.A2 = window.A3 = window.A4 = window.A5 = window.A6 = window.A7 = window.A8 = {};
        window.B1 = window.B2 = window.B3 = window.B4 = {};
        window.C1 = window.C2 = window.C3 = window.C4 = {};
        
        // 處理每一行數據
        data.forEach(row => {
            const city = row['城市'];
            if (!city) return;
            
            // 處理座標
            if (row['經度'] && row['緯度']) {
                window.geoCoordMap[city] = [parseFloat(row['經度']), parseFloat(row['緯度'])];
            }
            
            // 處理核定金額 (d1-d8)
            for (let i = 1; i <= 8; i++) {
                const year = 2016 + i;
                const amount = parseFloat(row[`${year}_核定金額`]) || 0;
                window[`d${i}`][city] = amount;
            }
            
            // 處理受益戶數 (A1-A8)
            for (let i = 1; i <= 8; i++) {
                const year = 2016 + i;
                const households = parseInt(row[`${year}_受益戶數`]) || 0;
                window[`A${i}`][city] = households;
            }
            
            // 處理受益人次 (B1-B4)
            for (let i = 1; i <= 4; i++) {
                const year = 2016 + i;
                const beneficiaries = parseInt(row[`${year}_受益人次`]) || 0;
                window[`B${i}`][city] = beneficiaries;
            }
            
            // 處理受益同住人 (C1-C4)
            for (let i = 1; i <= 4; i++) {
                const year = 2016 + i;
                const family = parseInt(row[`${year}_受益同住人`]) || 0;
                window[`C${i}`][city] = family;
            }
        });
        
        // 添加全台數據
        window.geoCoordMap['全台'] = [121.944845, 22.542893];
        
        // 計算全台總和
        for (let i = 1; i <= 8; i++) {
            window[`d${i}`]['全台'] = Object.values(window[`d${i}`]).reduce((a, b) => a + b, 0);
            window[`A${i}`]['全台'] = Object.values(window[`A${i}`]).reduce((a, b) => a + b, 0);
        }
    }
    
    // 初始化圖表
    function initChart() {
        chartDom = document.getElementById("main");
        myChart = echarts.init(chartDom);
        
        // 這裡是原有的圖表初始化代碼
        // 計算每年核定金額總和
        window.totalAmounts = {
            '2017': Object.values(d1).reduce((a, b) => a + b, 0),
            '2018': Object.values(d2).reduce((a, b) => a + b, 0),
            '2019': Object.values(d3).reduce((a, b) => a + b, 0),
            '2020': Object.values(d4).reduce((a, b) => a + b, 0),
            '2021': Object.values(d5).reduce((a, b) => a + b, 0),
            '2022': Object.values(d6).reduce((a, b) => a + b, 0),
            '2023': Object.values(d7).reduce((a, b) => a + b, 0),
            '2024': Object.values(d8).reduce((a, b) => a + b, 0)
        };

        // 計算每年受益戶數總和
        window.AtotalAmounts = {
            '2017': Object.values(A1).reduce((a, b) => a + b, 0),
            '2018': Object.values(A2).reduce((a, b) => a + b, 0),
            '2019': Object.values(A3).reduce((a, b) => a + b, 0),
            '2020': Object.values(A4).reduce((a, b) => a + b, 0),
            '2021': Object.values(A5).reduce((a, b) => a + b, 0),
            '2022': Object.values(A6).reduce((a, b) => a + b, 0),
            '2023': Object.values(A7).reduce((a, b) => a + b, 0),
            '2024': Object.values(A8).reduce((a, b) => a + b, 0)
        };
        
        // 這裡繼續原有的圖表初始化代碼...
        // 注意：以下代碼需要根據你的實際情況進行調整
        // 我假設你的圖表初始化代碼在 $.getJSON 回調函數中
        // 你需要將這些代碼移到 initChart 函數中
        
        // 載入地圖數據並初始化圖表
        $.getJSON(uploadedDataURL, function(geoJson) {
            // 這裡是原有的 $.getJSON 回調函數中的代碼
            // 將這些代碼移到這裡
            
            // 註冊地圖
            echarts.registerMap('TW', geoJson);
            
            // 這裡是原有的圖表選項配置
            // ...
            
            // 最後初始化圖表
            myChart.setOption(optionXyMap01);
            
            // 添加窗口大小調整監聽器
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        });
    }
    
    // 頁面載入完成後開始載入數據
    document.addEventListener('DOMContentLoaded', loadData);
    
    // 定義切換 Pin 類型的函數
    function switchPinType(type) {
        window.currentPinType = type;
        if (window.myChart && window.optionXyMap01) {
            window.myChart.setOption(window.optionXyMap01);
        }
    }

// 城市坐标数据
var geoCoordMap = {
    '高雄市': [120.63397253230777, 22.96510807924244],
    '台中市': [120.88303557156821, 24.22976722061671],
    '新北市': [121.56233791721156, 24.912096428815047],
    '屏東縣': [120.644845, 22.542893],
    '台南市': [120.32621160351262, 23.167583572934454],
    '桃園市': [121.22942515940727, 24.908913064300542],
    '花蓮縣': [121.427729, 23.783188],
    '台北市': [121.51185772382642, 25.02771294110296],
    '台東縣': [121.054566, 22.872413],
    '彰化縣': [120.472066, 23.990594],
    '雲林縣': [120.37140692500215, 23.7220205712259],
    '南投縣': [120.98222282177481, 23.862057901460222],
    '基隆市': [121.7090375475519, 25.115942332151228],
    '新竹縣': [121.15845951265977, 24.676877878638546],
    '苗栗縣': [120.92111693825872, 24.493472949565177],
    '嘉義縣': [120.6384686106581, 23.49204553894098],
    '宜蘭縣': [121.6827471803587, 24.55390323104749],
    '嘉義市': [120.44380244177937, 23.49123253156815],
    '新竹市': [120.97063102545773, 24.807783800541078],
    '澎湖縣': [119.61676029530447, 23.58029482756267],
    '金門縣': [118.38915926697726, 24.450510475737918],
    '全台': [121.944845, 22.542893]
};

// 2017年核定金额
var d1 = {
    '高雄市': 467136 ,
    '台中市': 688800,
    '屏東縣': 152010,
    '台南市': 212628,
    '桃園市': 514408,
    '嘉義縣': 354384,
     '全台':499680
};


// 2018年核定金额
var d2 = {
    '高雄市': 1273074,
    '台中市': 800400,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 967080,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};
// 2019年核定金额
var d3 = {
    '高雄市': 998870,
    '台中市': 993480,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 998870,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2020年核定金额 
var d4 = {
    '高雄市': 1006000,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 1084700,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 904458,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};
// 2021年核定金额 
var d5 = {
    '高雄市': 747500,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 749394,
    '花蓮縣': 749512,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 749698,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};
// 2022年核定金额 
var d6 = {
    '高雄市': 1007640,
    '台中市': 1484100,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 1251020,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 1005940,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};
// 2023年核定金额 
var d7 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 1377100,
    '桃園市': 1405740,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 1707240,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 513400,
    '金門縣': 0
};
// 2024年核定金额 
var d8 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 800160,
    '台南市': 1141340,
    '桃園市': 1138644,
    '花蓮縣': 1140660,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 1139156,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};



/*==========   受益戶數  A ===========*/

// 受益戶數數據
// 2017年受益戶數
var A1 = {
    '高雄市': 214,
    '台中市': 1984,
    '新北市': 0,
    '屏東縣': 69,
    '台南市': 560,
    '桃園市': 554,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 591,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0,
    '全台': 850,
};

// 2018年受益戶數
var A2 = {
    '高雄市': 1364,
    '台中市': 2143,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 1259,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2019年受益戶數 
var A3 = {
    '高雄市': 675,
    '台中市': 2309,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 366,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};



// 2020年受益戶數 (新增的第三年數據)
var A4 = {
    '高雄市': 582,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 378,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 2381,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2021年受益戶數 
var A5 = {
    '高雄市': 7269,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 740,
    '花蓮縣': 1180,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 21406,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2022年受益戶數 
var A6 = {
    '高雄市': 1081,
    '台中市': 338,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 766,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 584,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2023年受益戶數 
var A7 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 750,
    '桃園市': 500,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 650,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 2000,
    '金門縣': 0
};

// 2024年受益戶數 
var A8 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 174,
    '台南市': 701,
    '桃園市': 3426,
    '花蓮縣': 10669,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 20018,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

/*==========   受益人次 B  ===========*/
// 受益人次數據
// 2017年受益人次
var B1 = {
    '高雄市': 598,
    '台中市': 2709,
    '新北市': 0,
    '屏東縣': 188,
    '台南市': 47000,
    '桃園市': 832,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 1858,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2018年受益人次
var B2 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2019年受益人次 (新增的第三年數據)
var B3 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2020年受益人次 (新增的第三年數據)
var B4 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 受益同住人數據
// 2017年受益同住人
var C1 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2018年受益同住人
var C2 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 2019年受益同住人 (新增的第三年數據)
var C3 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};
// 2020年受益同住人 (新增的第三年數據)
var C4 = {
    '高雄市': 0,
    '台中市': 0,
    '新北市': 0,
    '屏東縣': 0,
    '台南市': 0,
    '桃園市': 0,
    '花蓮縣': 0,
    '台北市': 0,
    '台東縣': 0,
    '彰化縣': 0,
    '雲林縣': 0,
    '南投縣': 0,
    '基隆市': 0,
    '新竹縣': 0,
    '苗栗縣': 0,
    '嘉義縣': 0,
    '宜蘭縣': 0,
    '嘉義市': 0,
    '新竹市': 0,
    '澎湖縣': 0,
    '金門縣': 0
};

// 計算每年核定金額總和
var totalAmounts = {
    '2017': Object.values(d1).reduce((a, b) => a + b, 0),
    '2018': Object.values(d2).reduce((a, b) => a + b, 0),
    '2019': Object.values(d3).reduce((a, b) => a + b, 0),
    '2020': Object.values(d4).reduce((a, b) => a + b, 0),
    '2021': Object.values(d5).reduce((a, b) => a + b, 0),
    '2022': Object.values(d6).reduce((a, b) => a + b, 0),
    '2023': Object.values(d7).reduce((a, b) => a + b, 0),
    '2024': Object.values(d8).reduce((a, b) => a + b, 0)
};

// 計算每年受益戶數總和
var AtotalAmounts = {
    '2017': Object.values(A1).reduce((a, b) => a + b, 0),
    '2018': Object.values(A2).reduce((a, b) => a + b, 0),
    '2019': Object.values(A3).reduce((a, b) => a + b, 0),
    '2020': Object.values(A4).reduce((a, b) => a + b, 0),
    '2021': Object.values(A5).reduce((a, b) => a + b, 0),
    '2022': Object.values(A6).reduce((a, b) => a + b, 0),
    '2023': Object.values(A7).reduce((a, b) => a + b, 0),
    '2024': Object.values(A8).reduce((a, b) => a + b, 0)
};



var colors = [
    "#ff0076", "#F46E36", "#04B9FF", "#5DBD32", "#FFC809", 
    "#1DE9B6", "#BDA29A", "#6E7074", "#546570", "#C4CCD3"
];

var year = ["2017","2018", "2019", "2020", "2021", "2022", "2023", "2024"]; // 添加第四年
var mapData = [[], [], [], [], [], [], [], []]; // 四年份的数据
var pinData = [
    // 受益戶數数据 (第一种Pin数据)
    [[], [], [], [],[], [], [], []],
    // 受益人次数据 (第二种Pin数据)
    [[], [], [], [],[], [], [], []],
    // 受益同住人数据 (第三种Pin数据)
    [[], [], [], [], [], [], [], []]
];

// 定义显示哪种Pin数据的索引 (0:受益戶數, 1:受益人次, 2:受益同住人)
var currentPinType = 0;

/*柱子Y名称*/
var categoryData = [];
var barData = [];

// 准备核定金额数据
for (var key in geoCoordMap) {
   // 2017年数据
    mapData[0].push({
        "year": '2017',
        "name": key,
        "value": d1[key] || 0,
    });
    // 2018年数据
    mapData[1].push({
        "year": '2018',
        "name": key,
        "value": d2[key] || 0,
    });
    
    // 2019年数据
    mapData[2].push({
        "year": '2019',
        "name": key,
        "value": d3[key] || 0,
    });
    
    // 2020年数据
    mapData[3].push({
        "year": '2020',
        "name": key,
        "value": d4[key] || 0,
    });

    // 2021年数据
    mapData[4].push({
        "year": '2021',
        "name": key,
        "value": d5[key] || 0,
    });

    // 2022年数据
    mapData[5].push({
        "year": '2022',
        "name": key,
        "value": d6[key] || 0,
    });

    // 2023年数据
    mapData[6].push({
        "year": '2023',
        "name": key,
        "value": d7[key] || 0,
    });

        // 2024年数据
    mapData[7].push({
        "year": '2024',
        "name": key,
        "value": d8[key] || 0,
    });
    
  /* =======       准备各种Pin数据      ======== */

 
    // 受益戶數
    pinData[0][0].push({
        "year": '2017',
        "name": key,
        "value": A1[key] || 0,
    });
    pinData[0][1].push({
        "year": '2018',
        "name": key,
        "value": A2[key] || 0,
    });
    pinData[0][2].push({
        "year": '2019',
        "name": key,
        "value": A3[key] || 0,
    });
    pinData[0][3].push({
        "year": '2020',
        "name": key,
        "value": A4[key] || 0,
    });
    pinData[0][4].push({
        "year": '2021',
        "name": key,
        "value": A5[key] || 0,
    });
    pinData[0][5].push({
        "year": '2022',
        "name": key,
        "value": A6[key] || 0,
    });
    pinData[0][6].push({
        "year": '2023',
        "name": key,
        "value": A7[key] || 0,
    });
    pinData[0][7].push({
        "year": '2024',
        "name": key,
        "value": A8[key] || 0,
    });
    // 受益人次
    pinData[1][0].push({
        "year": '2017',
        "name": key,
        "value": B1[key] || 0,
    });
    pinData[1][1].push({
        "year": '2018',
        "name": key,
        "value": B2[key] || 0,
    });
    pinData[1][2].push({
        "year": '2019',
        "name": key,
        "value": B3[key] || 0,
    });
    pinData[1][3].push({
        "year": '2020',
        "name": key,
        "value": B4[key] || 0,
    });
    
    // 受益同住人
    pinData[2][0].push({
        "year": '2017',
        "name": key,
        "value": C1[key] || 0,
    });
    pinData[2][1].push({
        "year": '2018',
        "name": key,
        "value": C2[key] || 0,
    });
    pinData[2][2].push({
        "year": '2019',
        "name": key,
        "value": C3[key] || 0,
    });
    pinData[2][3].push({
        "year": '2020',
        "name": key,
        "value": C4[key] || 0,
    });
}

// 排序并准备柱状图数据
for (var i = 0; i < mapData.length; i++) {
    mapData[i].sort(function(a, b) {
        return a.value - b.value;
    });
    
    barData.push([]);
    categoryData.push([]);
    
    for (var j = 0; j < mapData[i].length; j++) {
        barData[i].push(mapData[i][j].value);
        categoryData[i].push(mapData[i][j].name);
    }
}

// 定义Pin类型的标题
var pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];

// 定义切换Pin类型的函数
function switchPinType(type) {
    currentPinType = type;
    myChart.setOption(optionXyMap01);
}

// 添加切换按钮
var buttonContainer = document.createElement('div');
buttonContainer.style.position = 'absolute';
buttonContainer.style.left = '10px';
buttonContainer.style.bottom = '50px';
buttonContainer.style.zIndex = '999';

for (var i = 0; i < pinTypeTitles.length; i++) {
    var button = document.createElement('button');
    button.innerHTML = pinTypeTitles[i];
    button.style.margin = '5px';
    button.style.padding = '5px 10px';
    button.style.backgroundColor = '#2B91B7';
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '3px';
    button.style.cursor = 'pointer';
    button.dataset.type = i;
    
    button.addEventListener('click', function() {
        switchPinType(parseInt(this.dataset.type));
    });
    
    buttonContainer.appendChild(button);
}

document.body.appendChild(buttonContainer);

$.getJSON(uploadedDataURL, function(geoJson) {
    echarts.registerMap('TW', geoJson);
    
    var convertData = function(data) {
        var res = [];
        for (var i = 0; i < data.length; i++) {
            var geoCoord = geoCoordMap[data[i].name];
            if (geoCoord && data[i].value > 0) {
                res.push({
                    name: data[i].name,
                    value: geoCoord.concat(data[i].value)
                });
            }
        }
        return res;
    };
    
    optionXyMap01 = {
        timeline: {
            data: year,
            axisType: 'category',
            autoPlay: true,
            playInterval: 3000,
            left: '10%',
            right: '10%',
            bottom: '3%',
            width: '80%',
            label: {
                normal: {
                    textStyle: {
                        color: '#ddd',
                        fontSize:15
                    }
                },
                emphasis: {
                    textStyle: {
                        color: '#fff',
                        fontSize:20
                    }
                }
            },
            symbolSize: 18,
            lineStyle: {
                color: '#555'
            },
            checkpointStyle: {
                borderColor: '#777',
                borderWidth: 2
            },
            controlStyle: {
                showNextBtn: true,
                showPrevBtn: true,
                normal: {
                    color: '#666',
                    borderColor: '#666'
                },
                emphasis: {
                    color: '#aaa',
                    borderColor: '#aaa'
                }
            }
        },
        baseOption: {
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicInOut',
            animationDurationUpdate: 1000,
            animationEasingUpdate: 'cubicInOut',
            grid: {
                right: '10%',
                top: '11%',
                bottom: '10%',
                width: '20%'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow',
                    shadowStyle: {
                        color: 'rgba(150,150,150,0.1)'
                    }
                }
            },
            geo: {
                    show: true,
                    map: 'TW',
                    layoutCenter: ['40%', '48%'],
                    roam: true,
                    layoutSize: '111%',
                    zoom: 1,
                    aspectScale: 1, //长宽比
                    center: [121, 23.5],  //中心点
                    label: {
                        emphasis: {
                            show: false
                        }
                    },
                itemStyle: {
                    normal: {
                        borderColor: 'rgba(147, 235, 248, 1)',
                        borderWidth: 1,
                        areaColor: {
                            type: 'radial',
                            x: 0.5,
                            y: 0.5,
                            r: 0.8,
                            colorStops: [{
                                offset: 0,
                                color: 'rgba(147, 235, 248, 0)'
                            }, {
                                offset: 1,
                                color: 'rgba(147, 235, 248, .2)'
                            }],
                            globalCoord: false
                        },
                        shadowColor: 'rgba(128, 217, 248, 1)',
                        shadowOffsetX: -2,
                        shadowOffsetY: 2,
                        shadowBlur: 10
                    },
                    emphasis: {
                        areaColor: '#389BB7',
                        borderWidth: 0
                    }
                }
            }
        },
        options: []
    };

    for (var n = 0; n < year.length; n++) {
        var formattedAmount = totalAmounts[year[n]].toLocaleString();
		var AformattedAmount = AtotalAmounts[year[n]].toLocaleString();
        

        optionXyMap01.options.push({
           // backgroundColor: '#000',
            title: [
                {
                    text: year[n] + ' 實物銀行 服務數據統計',
                    left: '18%',
                    top: '2%',
                    textStyle: {
                        color: '#fff',
                        fontSize: 32
                    }
                },
                {
                    id: 'statistic',
                    text: year[n] + " 核定金額 總計 :",
                    left: '70%',
                    top: '4%',
                    textStyle: {
                        color: '#fff',
                        fontSize: 26
                    }
                },
                {
                    id: 'totalAmount',
                    text: "$ " + formattedAmount,
                    left: '81%',
                    top: '4%',
                    textStyle: {
                        color: '#FFC809',
                        fontSize: 30
                    }
                },
                {
                    id: 'pinType',
                    text: pinTypeTitles[currentPinType] + " 總計",
                    left: '20%',
                    top: '11.5%',
                    textStyle: {
                        color: colors[currentPinType],
                        fontSize: 26
                    }
                },
                {
                    id: 'pinTypeAmount-A',
                    text: AformattedAmount +"戶" ,
                    left: '20%',
                    top: '15%',
                    textStyle: {
                        color: colors[currentPinType],
                        fontSize: 30
                    }
                }
            ],
            xAxis: {
                type: 'value',
                scale: true,
                position: 'top',
                min: 0,
                boundaryGap: false,
                splitLine: {
                    show: false
                },
                axisLine: {
                    show: false
                },
                axisTick: {
                    show: false
                },
                axisLabel: {
                    margin: 2,
                    textStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: {
                type: 'category',
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#ddd'
                    }
                },
                axisTick: {
                    show: false,
                    lineStyle: {
                        color: '#ddd'
                    }
                },
                axisLabel: {
                    interval: 0,
                    textStyle: {
                        color: '#ddd'
                    }
                },
                data: categoryData[n]
            },
            series: [
                {
                    // 地图底图
                    type: 'map',
                    map: 'TW',
                    geoIndex: 0,
                    aspectScale: 0.75,
                    showLegendSymbol: false,
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: false,
                            textStyle: {
                                color: '#fff'
                            }
                        }
                    },
                    roam: true,
                    itemStyle: {
                        normal: {
                            areaColor: '#031525',
                            borderColor: '#FFFFFF',
                        },
                        emphasis: {
                            areaColor: '#2B91B7'
                        }
                    },
                    animation: false,
                    data: mapData[n]
                },
                {
                    // 核定金额气泡
                    name: '核定金额',
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: convertData(mapData[n].sort(function(a, b) {
                        return b.value - a.value;
                    })),
                    symbolSize: function(val) {
                        return Math.sqrt(val[2]) / 40;
                    },
                    showEffectOn: 'render',
                    rippleEffect: {
                        brushType: 'stroke'
                    },
                    hoverAnimation: true,
                   //label: {
                   //     normal: {
                   //         formatter: '{b}: {c}',
                   //         position: 'right',
                   //         show: true
                   //     }
                   // },
                    itemStyle: {
                        normal: {
                            color: '#FFC809',
                            shadowBlur: 5,
                            shadowColor: '#FFC809'
                        }
                    },
                    zlevel: 1
                },
                {
                    // 不同类型的Pin数据
                    name: pinTypeTitles[currentPinType],
                    type: 'scatter',                    
                    coordinateSystem: 'geo',
                    symbol: 'pin', //气泡
                    symbolSize: function(val) {
                             return 32;
                         },
                    data: convertData(pinData[currentPinType][n].sort(function(a, b) {
                        return b.value - a.value;
                    })),
                    symbolSize: function(val) {
                        return Math.sqrt(val[2]) * 2.6;
                    },
                    label: {
                        normal: {
                            //formatter: function(params) {
                            //    return params.name + ': ' + params.value[2];
                            //},
                            formatter: function(params) {
                                return params.value[2];
                            },
                            //position: 'top',
                            show: true,
                            textStyle: {
                                color: '#fff',
                                fontSize: 15
                            }
                        }
                    },
                    itemStyle: {
                        normal: {
                            color: colors[currentPinType],
                            shadowBlur: 10,
                            shadowColor: colors[currentPinType]
                        }
                    },
                    zlevel: 2
                },
                {
                    // 右侧柱状图
                    zlevel: 1.5,
                    type: 'bar',
                    symbol: 'none',
                    itemStyle: {
                        normal: {
                            color: '#FFC809'
                        }
                    },
                    data: barData[n]
                }
            ]
        });
    }
    
    myChart.setOption(optionXyMap01);
    
    // 添加窗口大小调整监听器
    window.addEventListener('resize', function() {
        myChart.resize();
    });
});
    </script>
</body>
</html>

