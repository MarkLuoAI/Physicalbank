<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<style>
    body {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
  font-family: 'Montserrat', sans-serif;
}
</style>
<body>
    <div id="main" style="width: 100%; height: 100vh;"></div>
    <!-- Replace the entire script section with this: -->
<script>
    var chartDom = document.getElementById("main");
    var myChart = echarts.init(chartDom);
    var option;
    
    // Google Apps Script Web App URL - Replace with your published web app URL
    var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx97Sv0AaiveYNIqBetN2AxJjU3-y4MDgvwwnU4DwqJQOa4d5D0exzdnMTm7hgTejyW/exec';
    
    // 城市坐标数据
    var geoCoordMap = {
        '高雄市': [120.63397253230777, 22.96510807924244],
        '台中市': [120.88303557156821, 24.22976722061671],
        '新北市': [121.56233791721156, 24.912096428815047],
        '屏東縣': [120.644845, 22.542893],
        '台南市': [120.32621160351262, 23.167583572934454],
        '桃園市': [121.22942515940727, 24.908913064300542],
        '花蓮縣': [121.427729, 23.783188],
        '台北市': [121.51185772382642, 25.02771294110296],
        '台東縣': [121.054566, 22.872413],
        '彰化縣': [120.472066, 23.990594],
        '雲林縣': [120.37140692500215, 23.7220205712259],
        '南投縣': [120.98222282177481, 23.862057901460222],
        '基隆市': [121.7090375475519, 25.115942332151228],
        '新竹縣': [121.15845951265977, 24.676877878638546],
        '苗栗縣': [120.92111693825872, 24.493472949565177],
        '嘉義縣': [120.6384686106581, 23.49204553894098],
        '宜蘭縣': [121.6827471803587, 24.55390323104749],
        '嘉義市': [120.44380244177937, 23.49123253156815],
        '新竹市': [120.97063102545773, 24.807783800541078],
        '澎湖縣': [119.61676029530447, 23.58029482756267],
        '金門縣': [118.38915926697726, 24.450510475737918],
        '全台': [121.944845, 22.542893]
    };
    
    // Initialize empty data structures
    var years = [];
    var dataByYear = {};
    var pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];
    var currentPinType = 0;
    
    // Fetch data from Google Sheets
function fetchData() {
    console.log('開始載入 Google Sheets 數據...');
    // 使用 fetch 並添加時間戳避免緩存
    fetch(SCRIPT_URL + '?t=' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
            console.log('從 Google Sheets 載入的數據:', data);
            // 確保數據格式正確
            if (data && data.status === 'success' && Array.isArray(data.data)) {
                processData(data.data);
                initChart();
            } else {
                console.error('無效的數據格式:', data);
            }
        })
        .catch(error => {
            console.error('載入數據時發生錯誤:', error);
        });
    }

    // 處理返回的數據
    function handleData(response) {
        console.log('API Response:', response);
        
        if (response.status === 'error') {
            console.error('Server Error:', response.message, response.stack);
            return;
        }
        
        if (!response.data || !Array.isArray(response.data)) {
            console.error('從服務器接收到的數據格式無效');
            return;
        }
        
        processData(response.data);
        initChart();
    }
    
    function processData(data) {
        console.log('開始處理數據，共', data.length, '筆資料');
        console.log('第一筆資料結構:', data[0]);
        console.log('所有欄位:', Object.keys(data[0]));

        // 清空現有數據
        years = [];
        dataByYear = {};

        // 處理數據
        data.forEach((item, index) => {
            console.log(`處理第 ${index + 1} 筆資料:`, item);
            
            const year = item.年份 || item['年份'] || new Date().getFullYear().toString();
            const city = item.城市 || item['城市'] || '';
            const amount = parseFloat(item.核定金額 || item['核定金額'] || 0);
            const beneficiaries = parseInt(item.受益戶數 || item['受益戶數'] || 0);
            const visits = parseInt(item.受益人次 || item['受益人次'] || 0);
            const cohabitants = parseInt(item.受益同住人 || item['受益同住人'] || 0);

            // 確保年份存在於 years 數組中
            if (!years.includes(year)) {
                years.push(year);
                dataByYear[year] = {
                    d: {},  // 核定金額
                    A: {},  // 受益戶數
                    B: {},  // 受益人次
                    C: {}   // 受益同住人
                };
            }

            // 添加數據
            if (city) {
                dataByYear[year].d[city] = amount;
                dataByYear[year].A[city] = beneficiaries;
                dataByYear[year].B[city] = visits;
                dataByYear[year].C[city] = cohabitants;
            }
        });

        // 對年份進行排序
        years.sort();

        console.log('處理後的數據結構:', {
            years: years,
            dataByYear: dataByYear
        });
    }
    
    function initChart() {
        console.log('開始初始化圖表...');
        console.log('當前年份:', years);
        console.log('數據結構:', dataByYear);
        
        // 檢查是否有數據
        if (years.length === 0) {
            console.error('沒有可用的年份數據');
            return;
        }
        
        // 其餘的代碼保持不變
        // ...
    }
    
    // Helper function to get data for a specific year and type
    function getYearData(year, type) {
        return Object.keys(geoCoordMap).map(city => ({
            name: city,
            value: (dataByYear[year] && dataByYear[year][type] && dataByYear[year][type][city]) || 0
        }));
    }
    
    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', fetchData);
    
    // Rest of your existing code for chart options, styles, etc.
    // You'll need to modify the chart options to use the new data structure
    </script>
</body>
</html>

