<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <style>
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
        }
        #main {
            width: 100%;
            height: 100vh;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">資料載入中...</div>
    <div id="main"></div>

    <script>
        // 全局變量
        var chartDom, myChart, optionXyMap01;
        var currentPinType = 0;
        var pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];
        var colors = [
            "#ff0076", "#F46E36", "#04B9FF", "#5DBD32", "#FFC809", 
            "#1DE9B6", "#BDA29A", "#6E7074", "#546570", "#C4CCD3"
        ];
        var webAppUrl = "https://script.google.com/macros/s/AKfycbxoNLAmoFw_Jng2iFoFm_9BcUU-hvaIZOQG191rzu-nWZFqWJ-Jb2N59z1wV5OzY3hA/exec";
        
        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchData();
        });

        // 初始化圖表
        function initChart() {
            // 初始化將在 loadMapAndRender 中進行
            // 這裡只設置窗口大小調整監聽
            window.addEventListener('resize', function() {
                if (myChart) {
                    myChart.resize();
                }
            });
        }


        // 添加控制按鈕
        function addControlButtons() {
            var buttonContainer = document.createElement('div');
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.left = '10px';
            buttonContainer.style.bottom = '50px';
            buttonContainer.style.zIndex = '999';

            for (var i = 0; i < pinTypeTitles.length; i++) {
                var button = document.createElement('button');
                button.innerHTML = pinTypeTitles[i];
                button.style.margin = '5px';
                button.style.padding = '5px 10px';
                button.style.backgroundColor = '#2B91B7';
                button.style.color = '#fff';
                button.style.border = 'none';
                button.style.borderRadius = '3px';
                button.style.cursor = 'pointer';
                button.dataset.type = i;
                
                button.addEventListener('click', function() {
                    switchPinType(parseInt(this.dataset.type));
                });
                
                buttonContainer.appendChild(button);
            }


            document.body.appendChild(buttonContainer);
        }


        // 切換圖釘類型
        function switchPinType(type) {
            if (currentPinType !== type) {
                currentPinType = type;
                // 這裡可以添加切換圖釘類型的邏輯
            }
        }


        // 從 Google Apps Script 獲取數據
        function fetchData() {
            fetch(webAppUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    processData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('loading').textContent = '數據加載失敗，請刷新頁面重試';
                });
        }


        // 處理數據
        function processData(data) {
            console.log('開始處理數據，輸入數據:', data);
            
            // 存儲處理後的數據
            window.appData = {
                geoCoordMap: {},
                years: [],
                data: {}
            };

            // 提取年份
            const years = new Set();
            for (const key in data) {
                if (key.startsWith('Y') && data[key]) {
                    years.add(key.substring(1));
                }
            }
            window.appData.years = Array.from(years).sort();

            // 處理地理坐標和數據
            for (const key in data) {
                if (key === 'geoCoord') {
                    // 處理地理坐標
                    try {
                        const geoData = JSON.parse(data[key]);
                        for (const city in geoData) {
                            if (geoData[city] && Array.isArray(geoData[city]) && geoData[city].length === 2) {
                                window.appData.geoCoordMap[city] = geoData[city];
                            }
                        }
                    } catch (e) {
                        console.error('解析地理坐標數據失敗:', e);
                    }
                } else if (key.startsWith('Y') && data[key]) {
                    // 處理年份數據
                    const year = key.substring(1);
                    try {
                        const yearData = JSON.parse(data[key]);
                        window.appData.data[year] = yearData;
                    } catch (e) {
                        console.error(`解析${year}年數據失敗:`, e);
                    }
                }
            }


            // 加載地圖並渲染圖表
            loadMapAndRender();
        }


        // 加載地圖並渲染圖表
        function loadMapAndRender() {
            const mapUrl = "https://slimmay.github.io/storeTW/twCounty2010.json";
            
            // 顯示加載動畫
            document.getElementById('loading').style.display = 'block';
            
            // 加載地圖數據
            fetch(mapUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(mapJson => {
                    // 註冊地圖
                    echarts.registerMap('taiwan', mapJson);
                    
                    // 初始化圖表
                    chartDom = document.getElementById('main');
                    myChart = echarts.init(chartDom);
                    
                    // 添加控制按鈕
                    addControlButtons();
                    
                    // 渲染圖表
                    renderChart();
                    
                    // 隱藏加載動畫
                    document.getElementById('loading').style.display = 'none';
                })
                .catch(error => {
                    console.error('加載地圖失敗:', error);
                    document.getElementById('loading').textContent = '加載地圖失敗，請檢查網絡連接';
                });
        }


        // 渲染圖表
        function renderChart() {
            const data = window.appData;
            const years = data.years;
            const geoCoordMap = data.geoCoordMap;
            
            // 準備數據
            const mapData = [];
            const pinData = [[], [], []]; // 三種類型的圖釘數據
            const totalAmounts = {};
            const AtotalAmounts = {};
            
            // 確保 geoCoordMap 中的城市名稱與地圖數據匹配
            const normalizeCityName = (city) => {
                // 將城市名稱轉換為與地圖數據匹配的格式
                const cityMap = {
                    '台北市': '臺北市',
                    '台中市': '臺中市',
                    '台南市': '臺南市',
                    '台東縣': '臺東縣'
                };
                return cityMap[city] || city;
            };
            
            // 處理每年的數據
            years.forEach((year, yearIndex) => {
                const yearData = data.data[year];
                
                // 計算總額
                totalAmounts[year] = Object.values(yearData.d).reduce((a, b) => a + (parseInt(b) || 0), 0);
                AtotalAmounts[year] = Object.values(yearData.A).reduce((a, b) => a + (parseInt(b) || 0), 0);
                
                // 準備地圖和圖釘數據
                const mapYearData = [];
                const pinYearData = [[], [], []];
                
                // 為每個城市添加數據
                Object.keys(geoCoordMap).forEach(city => {
                    const normalizedCity = normalizeCityName(city);
                    const cityData = yearData.d[city] || 0;
                    const cityDataA = yearData.A[city] || 0;
                    const cityDataB = yearData.B[city] || 0;
                    const cityDataC = yearData.C[city] || 0;
                    
                    // 地圖數據
                    mapYearData.push({
                        name: normalizedCity,
                        value: parseInt(cityData) || 0,
                        // 確保坐標存在
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    // 圖釘數據 (三種類型)
                    pinYearData[0].push({
                        name: normalizedCity,
                        value: parseInt(cityDataA) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    pinYearData[1].push({
                        name: normalizedCity,
                        value: parseInt(cityDataB) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    pinYearData[2].push({
                        name: normalizedCity,
                        value: parseInt(cityDataC) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                });
                
                // 排序地圖數據
                mapYearData.sort((a, b) => a.value - b.value);
                mapData.push(mapYearData);
                
                // 排序圖釘數據
                pinYearData.forEach((typeData, typeIndex) => {
                    pinData[typeIndex].push([...typeData].sort((a, b) => a.value - b.value));
                });
            });
            
            // 準備圖表選項
            optionXyMap01 = {
                baseOption: {
                    // 確保正確設置地理坐標系
                    backgroundColor: '#fff',
                    timeline: {
                        data: years,
                        axisType: 'category',
                        autoPlay: true,
                        playInterval: 3000,
                        left: '10%',
                        right: '10%',
                        bottom: '3%',
                        width: '80%',
                        label: {
                            normal: {
                                textStyle: {
                                    color: '#ddd',
                                    fontSize: 15
                                }
                            },
                            emphasis: {
                                textStyle: {
                                    color: '#fff',
                                    fontSize: 20
                                }
                            }
                        },
                        symbolSize: 18,
                        lineStyle: {
                            color: '#555'
                        },
                        checkpointStyle: {
                            borderColor: '#777',
                            borderWidth: 2
                        },
                        controlStyle: {
                            showNextBtn: true,
                            showPrevBtn: true,
                            normal: {
                                color: '#666',
                                borderColor: '#666'
                            },
                            emphasis: {
                                color: '#aaa',
                                borderColor: '#aaa'
                            }
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.seriesType === 'scatter') {
                                return params.name + '<br/>' + params.marker + ' ' + params.seriesName + ': ' + params.value[2];
                            }
                            return params.name;
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: 1000000,
                        text: ['高', '低'],
                        realtime: false,
                        calculable: true,
                        inRange: {
                            color: ['#e0f7fa', '#4fc3f7', '#0288d1', '#01579b']
                        },
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    geo: {
                        map: 'taiwan',
                        roam: true,
                        zoom: 1.2,
                        center: [120.8, 23.5],
                        label: {
                            show: true,
                            color: '#000',
                            fontSize: 10
                        },
                        itemStyle: {
                            areaColor: '#f5f5f5',
                            borderColor: '#999',
                            borderWidth: 0.5
                        },
                        emphasis: {
                            label: {
                                show: true,
                                color: '#fff'
                            },
                            itemStyle: {
                                areaColor: '#4b0082'
                            }
                        }
                    },
                    series: [],
                    animation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicInOut',
                    animationDurationUpdate: 1000,
                    animationEasingUpdate: 'cubicInOut',
                    grid: {
                        right: '10%',
                        top: '11%',
                        bottom: '10%',
                        width: '20%'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: {
                                color: 'rgba(150,150,150,0.1)'
                            }
                        }
                    },
                    geo: {
                        show: true,
                        map: 'taiwan',
                        layoutCenter: ['40%', '48%'],
                        roam: true,
                        layoutSize: '111%',
                        zoom: 1,
                        aspectScale: 1,
                        center: [121, 23.5],
                        label: {
                            emphasis: {
                                show: false
                            }
                        },
                        itemStyle: {
                            normal: {
                                borderColor: 'rgba(147, 235, 248, 1)',
                                borderWidth: 1,
                                areaColor: {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.8,
                                    colorStops: [{
                                        offset: 0,
                                        color: 'rgba(147, 235, 248, 0)'
                                    }, {
                                        offset: 1,
                                        color: 'rgba(147, 235, 248, .2)'
                                    }],
                                    globalCoord: false
                                },
                                shadowColor: 'rgba(128, 217, 248, 1)',
                                shadowOffsetX: -2,
                                shadowOffsetY: 2,
                                shadowBlur: 10
                            },
                            emphasis: {
                                areaColor: '#389BB7',
                                borderWidth: 0
                            }
                        }
                    }
                },
                options: []
            };

            // 為每一年添加選項
            years.forEach((year, yearIndex) => {
                const formattedAmount = totalAmounts[year].toLocaleString();
                const AformattedAmount = AtotalAmounts[year].toLocaleString();
                
                // 轉換為地圖坐標
                const convertData = (data) => {
                    return data
                        .filter(item => item.value > 0)
                        .map(item => ({
                            name: item.name,
                            value: [...(geoCoordMap[item.name] || []), item.value]
                        }));
                };

                optionXyMap01.options.push({
                    title: [
                        {
                            text: year + ' 實物銀行 服務數據統計',
                            left: '18%',
                            top: '5%',
                            textStyle: {
                                color: '#fff',
                                fontSize: 20,
                                fontWeight: 'bold'
                            }
                        },
                        {
                            text: '總服務人數: ' + formattedAmount + ' 人',
                            left: '82%',
                            top: '5%',
                            textAlign: 'center',
                            textStyle: {
                                color: '#fff',
                                fontSize: 14
                            }
                        },
                        {
                            text: '受益戶數: ' + AformattedAmount + ' 戶',
                            left: '82%',
                            top: '10%',
                            textAlign: 'center',
                            textStyle: {
                                color: '#fff',
                                fontSize: 14
                            }
                        }
                    ],
                    series: [
                        {
                            name: '地圖',
                            type: 'map',
                            map: 'taiwan',
                            geoIndex: 0,
                            aspectScale: 0.75,
                            layoutCenter: ['50%', '50%'],
                            layoutSize: '100%',
                            zoom: 1.2,
                            roam: true,
                            label: {
                                show: true,
                                color: '#fff',
                                fontSize: 10
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#fff',
                                    fontSize: 12
                                },
                                itemStyle: {
                                    areaColor: '#4b0082'
                                }
                            },
                            data: mapData[yearIndex].map(item => ({
                                name: item.name,
                                value: item.value,
                                itemStyle: {
                                    color: {
                                        type: 'radial',
                                        x: 0.5,
                                        y: 0.5,
                                        r: 0.8,
                                        colorStops: [{
                                            offset: 0,
                                            color: 'rgba(147, 235, 248, 0)'
                                        }, {
                                            offset: 1,
                                            color: 'rgba(147, 235, 248, .8)'
                                        }],
                                        globalCoord: false
                                    }
                                }
                            }))
                        },
                        {
                            name: '散點',
                            type: 'scatter',
                            coordinateSystem: 'geo',
                            data: convertData(pinData[currentPinType][yearIndex]),
                            symbolSize: function(val) {
                                return Math.min(Math.max(val[2] / 100, 5), 20);
                            },
                            showEffectOn: 'render',
                            rippleEffect: {
                                brushType: 'stroke'
                            },
                            hoverAnimation: true,
                            label: {
                                formatter: function(params) {
                                    return params.data.name;
                                },
                                position: 'right',
                                show: false
                            },
                            itemStyle: {
                                color: '#ffeb3b',
                                shadowBlur: 10,
                                shadowColor: '#333'
                            },
                            emphasis: {
                                label: {
                                    show: true
                                }
                            },
                            zlevel: 1
                        }
                    ]
                });
            });

            // 清除之前的圖表實例
            myChart.clear();
            
            // 設置新的圖表選項
            myChart.setOption(optionXyMap01, true);
            
            // 顯示加載動畫
            myChart.showLoading();
            
            // 模擬數據加載延遲
            setTimeout(() => {
                myChart.hideLoading();
                myChart.setOption(optionXyMap01);
                
                // 觸發圖表重繪
                setTimeout(() => {
                    myChart.dispatchAction({
                        type: 'highlight',
                        seriesIndex: 0,
                        dataIndex: 0
                    });
                }, 100);
            }, 1000);
        }
    </script>
</body>
</html>
