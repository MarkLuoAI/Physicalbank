<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <style>
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
        }
        #main {
            width: 100%;
            height: 100vh;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">資料載入中...</div>
    <div id="main"></div>

    <script>
        // 全局變量
        var chartDom, myChart, optionXyMap01;
        var currentPinType = 0;
        var pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];
        var colors = [
            "#ff0076", "#F46E36", "#04B9FF", "#5DBD32", "#FFC809", 
            "#1DE9B6", "#BDA29A", "#6E7074", "#546570", "#C4CCD3"
        ];
        var webAppUrl = "https://script.google.com/macros/s/AKfycbxoNLAmoFw_Jng2iFoFm_9BcUU-hvaIZOQG191rzu-nWZFqWJ-Jb2N59z1wV5OzY3hA/exec";
        
        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchData();
        });

        // 初始化圖表
        function initChart() {
            // 初始化將在 loadMapAndRender 中進行
            // 這裡只設置窗口大小調整監聽
            window.addEventListener('resize', function() {
                if (myChart) {
                    myChart.resize();
                }
            });
        }

        // 添加控制按鈕
        function addControlButtons() {
            var buttonContainer = document.createElement('div');
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.left = '10px';
            buttonContainer.style.bottom = '50px';
            buttonContainer.style.zIndex = '999';

            for (var i = 0; i < pinTypeTitles.length; i++) {
                var button = document.createElement('button');
                button.innerHTML = pinTypeTitles[i];
                button.style.margin = '5px';
                button.style.padding = '5px 10px';
                button.style.backgroundColor = '#2B91B7';
                button.style.color = '#fff';
                button.style.border = 'none';
                button.style.borderRadius = '3px';
                button.style.cursor = 'pointer';
                button.dataset.type = i;
                
                button.addEventListener('click', function() {
                    switchPinType(parseInt(this.dataset.type));
                });
                
                buttonContainer.appendChild(button);
            }

            document.body.appendChild(buttonContainer);
        }

        // 切換圖釘類型
        function switchPinType(type) {
            if (currentPinType !== type) {
                currentPinType = type;
                renderChart();
            }
        }

        // 從 Google Apps Script 獲取數據
        async function fetchData() {
            try {
                console.log('開始獲取數據，URL:', webAppUrl);
                const response = await fetch(webAppUrl);
                console.log('收到響應，狀態:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('解析的JSON數據:', result);
                
                if (!result || result.length === 0) {
                    throw new Error('接收到的數據為空');
                }
                
                // 處理數據
                processData(result);
                
                // 加載地圖並渲染圖表
                loadMapAndRender();
                
            } catch (error) {
                console.error('獲取數據失敗:', error);
                const errorMessage = `數據加載失敗: ${error.message || '未知錯誤'}`;
                console.error(errorMessage);
                document.getElementById('loading').textContent = errorMessage;
            }
        }

        // 處理數據
        function processData(data) {
            console.log('開始處理數據，輸入數據:', data);
            
            // 使用從服務器返回的 geoCoordMap 和 years
            const geoCoordMap = data.geoCoordMap || {};
            const dataArray = Array.isArray(data.data) ? data.data : [];
            
            // 從數據中提取所有唯一的年份
            const yearSet = new Set();
            
            // 處理數據並提取年份
            const processedData = dataArray.map(item => {
                if (typeof item.year === 'string' && item.year.includes(',')) {
                    // 處理逗號分隔的字符串格式: "2017,高雄市,467136,214,598,0"
                    const [year, city, amount, households, people, cohabitants] = item.year.split(',');
                    return {
                        year: year.trim(),
                        city: city.trim(),
                        amount: parseInt(amount || 0) || 0,
                        households: parseInt(households || 0) || 0,
                        people: parseInt(people || 0) || 0,
                        cohabitants: parseInt(cohabitants || 0) || 0
                    };
                }
                return item;
            });
            
            // 從處理後的數據中提取年份
            processedData.forEach(item => {
                if (item.year) {
                    yearSet.add(item.year.toString());
                }
            });
            
            const years = Array.from(yearSet).sort();
            
            console.log('處理後的數據:', {
                geoCoordMap,
                years,
                data: processedData
            });
            
            if (years.length === 0) {
                const errorMsg = '錯誤: 未找到有效的年份數據。請檢查數據源是否包含有效的年份字段。';
                console.error(errorMsg);
                throw new Error(errorMsg);
            }
            
            // 按年份排序
            years.sort();
            console.log('找到的年份:', years);
            
            // 初始化應用數據
            window.appData = {
                geoCoordMap: geoCoordMap,
                years: years,
                data: {}
            };

            console.log('初始化數據結構...');
            // 初始化每年的數據結構
            years.forEach(year => {
                window.appData.data[year] = {
                    d: {}, // 核定金額
                    A: {}, // 受益戶數
                    B: {}, // 受益人次
                    C: {}  // 受益同住人
                };
                
                // 初始化每個城市的默認值
                Object.keys(geoCoordMap).forEach(city => {
                    window.appData.data[year].d[city] = 0;
                    window.appData.data[year].A[city] = 0;
                    window.appData.data[year].B[city] = 0;
                    window.appData.data[year].C[city] = 0;
                });
            });

            console.log('開始填充數據...');
            // 填充數據
            processedData.forEach((item, index) => {
                try {
                    const year = item.year.toString();
                    const city = item.city;
                    
                    if (!year || !city) {
                        console.warn(`跳過無效的數據項 ${index}:`, item);
                        return;
                    }
                    
                    if (!window.appData.data[year]) {
                        console.warn(`跳過無效的年份 ${year} 的數據`);
                        return;
                    }
                    
                    // 獲取各項數據
                    const amount = parseInt(item.amount) || 0;
                    const households = parseInt(item.households) || 0;
                    const people = parseInt(item.people) || 0;
                    const cohabitants = parseInt(item.cohabitants) || 0;
                    
                    // 更新數據
                    if (window.appData.data[year] && city in geoCoordMap) {
                        window.appData.data[year].d[city] = amount;
                        window.appData.data[year].A[city] = households;
                        window.appData.data[year].B[city] = people;
                        window.appData.data[year].C[city] = cohabitants;
                        
                        console.log(`處理項目 ${index}:`, { 
                            year, 
                            city, 
                            amount,
                            households,
                            people,
                            cohabitants 
                        });
                    } else {
                        console.warn(`跳過無效的城市 ${city} 的數據`);
                    }
                } catch (error) {
                    console.error(`處理數據項 ${index} 時出錯:`, error, '數據項:', item);
                }
            });
            
            console.log('數據處理完成，結果:', window.appData);
        }

        // 加載地圖並渲染圖表
        function loadMapAndRender() {
            const mapUrl = "https://slimMay.github.io/storeTW/twCounty2010.json";
            console.log('開始加載地圖數據...');
            
            // 先初始化圖表實例
            chartDom = document.getElementById('main');
            myChart = echarts.init(chartDom);
            
            // 顯示加載動畫
            myChart.showLoading();
            
            fetch(mapUrl)
                .then(response => {
                    console.log('地圖數據響應狀態:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(mapJson => {
                    console.log('地圖數據加載成功', mapJson);
                    
                    try {
                        // 確保地圖數據是有效的 GeoJSON
                        if (!mapJson.type || !mapJson.features) {
                            throw new Error('無效的地圖數據格式: 缺少必要的 GeoJSON 屬性');
                        }
                        
                        // 處理地圖特徵，確保每個特徵都有必要的屬性
                        const features = mapJson.features.map(feature => {
                            const properties = feature.properties || {};
                            // 確保每個特徵都有必要的屬性
                            const name = properties.name || properties.NAME || properties.COUNTYNAME || '未知地區';
                            
                            // 創建新的特徵對象，確保不修改原始數據
                            const newFeature = {
                                ...feature,
                                properties: {
                                    ...properties,
                                    name: name,
                                    cp: properties.cp || [120, 23.5],
                                    childNum: properties.childNum || 1
                                }
                            };
                            
                            // 確保幾何類型正確
                            if (!newFeature.geometry || !newFeature.geometry.type) {
                                console.warn('無效的幾何類型:', newFeature);
                                return null;
                            }
                            
                            return newFeature;
                        }).filter(Boolean); // 過濾掉無效的特徵
                        
                        if (features.length === 0) {
                            throw new Error('沒有有效的特徵數據');
                        }
                        
                        // 創建一個新的 GeoJSON 對象
                        const geoJson = {
                            type: 'FeatureCollection',
                            features: features
                        };
                        
                        console.log('註冊地圖...', geoJson);
                        
                        // 註冊地圖
                        echarts.registerMap('taiwan', geoJson);
                        console.log('地圖註冊成功');
                        
                        // 添加控制按鈕
                        addControlButtons();
                        
                        // 立即渲染圖表
                        console.log('開始渲染圖表...');
                        renderChart();
                        
                        // 隱藏加載動畫
                        myChart.hideLoading();
                    } catch (e) {
                        console.error('處理地圖數據時出錯:', e);
                        throw e;
                    }
                })
                .catch(error => {
                    const errorMsg = `加載地圖失敗: ${error.message || '未知錯誤'}`;
                    console.error(errorMsg, error);
                    document.getElementById('loading').textContent = errorMsg;
                });
        }

        // 渲染圖表
        function renderChart() {
            const data = window.appData;
            const years = data.years;
            const geoCoordMap = data.geoCoordMap;
            
            // 準備數據
            const mapData = [];
            const pinData = [[], [], []]; // 三種類型的圖釘數據
            const totalAmounts = {};
            const AtotalAmounts = {};
            
            // 確保 geoCoordMap 中的城市名稱與地圖數據匹配
            const normalizeCityName = (city) => {
                // 將城市名稱轉換為與地圖數據匹配的格式
                const cityMap = {
                    '台北市': '臺北市',
                    '台中市': '臺中市',
                    '台南市': '臺南市',
                    '台東縣': '臺東縣'
                };
                return cityMap[city] || city;
            };
            
            // 處理每年的數據
            years.forEach((year, yearIndex) => {
                const yearData = data.data[year];
                
                // 計算總額
                totalAmounts[year] = Object.values(yearData.d).reduce((a, b) => a + (parseInt(b) || 0), 0);
                AtotalAmounts[year] = Object.values(yearData.A).reduce((a, b) => a + (parseInt(b) || 0), 0);
                
                // 準備地圖和圖釘數據
                const mapYearData = [];
                const pinYearData = [[], [], []];
                
                // 為每個城市添加數據
                Object.keys(geoCoordMap).forEach(city => {
                    const normalizedCity = normalizeCityName(city);
                    const cityData = yearData.d[city] || 0;
                    const cityDataA = yearData.A[city] || 0;
                    const cityDataB = yearData.B[city] || 0;
                    const cityDataC = yearData.C[city] || 0;
                    
                    // 地圖數據
                    mapYearData.push({
                        name: normalizedCity,
                        value: parseInt(cityData) || 0,
                        // 確保坐標存在
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    // 圖釘數據 (三種類型)
                    pinYearData[0].push({
                        name: normalizedCity,
                        value: parseInt(cityDataA) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    pinYearData[1].push({
                        name: normalizedCity,
                        value: parseInt(cityDataB) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                    
                    pinYearData[2].push({
                        name: normalizedCity,
                        value: parseInt(cityDataC) || 0,
                        coord: geoCoordMap[city] || [120, 23.5]
                    });
                });
                
                // 排序地圖數據
                mapYearData.sort((a, b) => a.value - b.value);
                mapData.push(mapYearData);
                
                // 排序圖釘數據
                pinYearData.forEach((typeData, typeIndex) => {
                    pinData[typeIndex].push([...typeData].sort((a, b) => a.value - b.value));
                });
            });
            
            // 準備類別數據 (用於柱狀圖)
            const categoryData = mapData[0].map(item => item.name);
            
            // 定義圖釘類型標題
            const pinTypeTitles = ['核定金額', '服務戶數', '服務人數'];
            const currentPinType = 0; // 默認顯示第一種類型
            const colors = ['#FFC809', '#FF6B6B', '#4CAF50']; // 每種圖釘類型的顏色
            
            // 轉換數據格式為 [lng, lat, value] 格式
            const convertData = (data) => {
                return data.map(item => {
                    const coord = geoCoordMap[item.name] || [121, 23.5];
                    return {
                        name: item.name,
                        value: [...coord, item.value],
                        label: {
                            formatter: `{b}\n{@[2]}`,  // 顯示名稱和值
                            position: 'right',
                            show: true
                        }
                    };
                });
            };
            
            // 準備圖表選項
            optionXyMap01 = {
                baseOption: {
                    // 確保正確設置地理坐標系
                    backgroundColor: '#fff',
                    timeline: {
                        data: years,
                        axisType: 'category',
                        autoPlay: true,
                        playInterval: 3000,
                        left: '10%',
                        right: '10%',
                        bottom: '3%',
                        width: '80%',
                        label: {
                            normal: {
                                textStyle: {
                                    color: '#ddd',
                                    fontSize: 15
                                }
                            },
                            emphasis: {
                                textStyle: {
                                    color: '#fff',
                                    fontSize: 20
                                }
                            }
                        },
                        symbolSize: 18,
                        lineStyle: {
                            color: '#555'
                        },
                        checkpointStyle: {
                            borderColor: '#777',
                            borderWidth: 2
                        },
                        controlStyle: {
                            showNextBtn: true,
                            showPrevBtn: true,
                            normal: {
                                color: '#666',
                                borderColor: '#666'
                            },
                            emphasis: {
                                color: '#aaa',
                                borderColor: '#aaa'
                            }
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.seriesType === 'scatter') {
                                return params.name + '<br/>' + params.marker + ' ' + params.seriesName + ': ' + params.value[2];
                            } else if (params.seriesType === 'map') {
                                return params.name + ': ' + (params.value || 0);
                            }
                            return params.name;
                        }
                    },
                    geo: {
                        map: 'taiwan',
                        roam: true,
                        zoom: 1.2,
                        center: [121, 23.5],
                        label: {
                            show: true,
                            color: '#000',
                            fontSize: 10
                        },
                        itemStyle: {
                            areaColor: '#f5f5f5',
                            borderColor: '#999',
                            borderWidth: 0.5
                        },
                        emphasis: {
                            label: {
                                show: true,
                                color: '#fff'
                            },
                            itemStyle: {
                                areaColor: '#4b0082'
                            }
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: 1000000,
                        text: ['高', '低'],
                        realtime: false,
                        calculable: true,
                        precision: 0,
                        formatter: function (value) {
                            return value.toLocaleString();
                        },
                        inRange: {
                            color: ['#e0f7fa', '#4fc3f7', '#0288d1', '#01579b']
                        },
                        textStyle: {
                            color: '#fff'
                        },
                        seriesIndex: 0,
                        dimension: 2
                    },
                    geo: {
                        map: 'taiwan',
                        roam: true,
                        zoom: 1.2,
                        center: [121, 23.5],
                        label: {
                            show: true,
                            color: '#000',
                            fontSize: 10
                        },
                        itemStyle: {
                            areaColor: '#f5f5f5',
                            borderColor: '#999',
                            borderWidth: 0.5
                        },
                        emphasis: {
                            label: {
                                show: true,
                                color: '#fff'
                            },
                            itemStyle: {
                                areaColor: '#4b0082'
                            }
                        }
                },
                    series: [],
                    animation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicInOut',
                    animationDurationUpdate: 1000,
                    animationEasingUpdate: 'cubicInOut',
                    grid: {
                        right: '10%',
                        top: '11%',
                        bottom: '10%',
                        width: '20%'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: {
                                color: 'rgba(150,150,150,0.1)'
                            }
                        }
                    },
                    geo: {
                        show: true,
                        map: 'taiwan',
                        layoutCenter: ['40%', '48%'],
                        roam: true,
                        layoutSize: '111%',
                        zoom: 1,
                        aspectScale: 1,
                        center: [121, 23.5],
                        label: {
                            emphasis: {
                                show: false
                            }
                        },
                        itemStyle: {
                            normal: {
                                borderColor: 'rgba(147, 235, 248, 1)',
                                borderWidth: 1,
                                areaColor: {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.8,
                                    colorStops: [{
                                        offset: 0,
                                        color: 'rgba(147, 235, 248, 0)'
                                    }, {
                                        offset: 1,
                                        color: 'rgba(147, 235, 248, .2)'
                                    }],
                                    globalCoord: false
                                },
                                shadowColor: 'rgba(128, 217, 248, 1)',
                                shadowOffsetX: -2,
                                shadowOffsetY: 2,
                                shadowBlur: 10
                            },
                            emphasis: {
                                areaColor: '#389BB7',
                                borderWidth: 0
                            }
                        }
                    }
                },
                options: []
            };

            // 為每一年添加選項
            years.forEach((year, yearIndex) => {
                const formattedAmount = totalAmounts[year].toLocaleString();
                const AformattedAmount = AtotalAmounts[year].toLocaleString();
                
                // 轉換為地圖坐標
                const convertData = (data) => {
                    return data
                        .filter(item => item.value > 0)
                        .map(item => ({
                            name: item.name,
                            value: [...(geoCoordMap[item.name] || []), item.value]
                        }));
                };

                optionXyMap01.options.push({
                    title: [
                        {
                            text: year + ' 實物銀行 服務數據統計',
                            left: '18%',
                            top: '2%',
                            textStyle: {
                                color: '#fff',
                                fontSize: 32
                            }
                        },
                        {
                            id: 'statistic',
                            text: year + " 核定金額 總計 :",
                            left: '70%',
                            top: '4%',
                            textStyle: {
                                color: '#fff',
                                fontSize: 26
                            }
                        },
                        {
                            id: 'totalAmount',
                            text: "$ " + formattedAmount,
                            left: '81%',
                            top: '4%',
                            textStyle: {
                                color: '#FFC809',
                                fontSize: 30
                            }
                        },
                        {
                            id: 'pinType',
                            text: pinTypeTitles[currentPinType] + " 總計",
                            left: '20%',
                            top: '11.5%',
                            textStyle: {
                                color: colors[currentPinType],
                                fontSize: 26
                            }
                        },
                        {
                            id: 'pinTypeAmount-A',
                            text: AformattedAmount + "戶",
                            left: '20%',
                            top: '15%',
                            textStyle: {
                                color: colors[currentPinType],
                                fontSize: 30
                            }
                        }
                    ],
                    xAxis: {
                        type: 'value',
                        scale: true,
                        position: 'top',
                        min: 0,
                        boundaryGap: false,
                        splitLine: {
                            show: false
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        },
                        axisLabel: {
                            margin: 2,
                            textStyle: {
                                color: '#aaa'
                            }
                        }
                    },
                    yAxis: {
                        type: 'category',
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        axisTick: {
                            show: false,
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        axisLabel: {
                            interval: 0,
                            textStyle: {
                                color: '#ddd'
                            }
                        },
                        data: categoryData
                    },
                    series: [
                        {
                            // 地圖底圖
                            name: '地圖',
                            type: 'map',
                            map: 'taiwan',
                            roam: true,
                            zoom: 1.2,
                            center: [121, 23.5],
                            label: {
                                show: true,
                                color: '#000',
                                fontSize: 10
                            },
                            itemStyle: {
                                areaColor: '#f5f5f5',
                                borderColor: '#999',
                                borderWidth: 0.5
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#fff'
                                },
                                itemStyle: {
                                    areaColor: '#4b0082'
                                }
                            },
                            data: (mapData[yearIndex] || []).map(item => ({
                                name: item.name,
                                value: item.value || 0
                            })).filter(item => item.value > 0), // 只顯示有值的數據點
                            selectedMode: 'single',
                            silent: true, // 禁用默認的點擊事件
                        },
                        {
                            // 圖釘數據
                            name: pinTypeTitles[currentPinType] || '數據',
                            type: 'scatter',
                            coordinateSystem: 'geo',
                            symbol: 'pin',
                            data: convertData([...(pinData[currentPinType]?.[yearIndex] || [])].sort((a, b) => (b?.value || 0) - (a?.value || 0))),
                            symbolSize: function(val) {
                                if (!val || !Array.isArray(val.value) || val.value.length < 3) return 15;
                                const size = Math.sqrt(val.value[2]) * 0.5;
                                return Math.min(Math.max(size, 15), 40);
                            },
                            label: {
                                show: true,
                                formatter: function(params) {
                                    return params.value?.[2]?.toLocaleString() || '0';
                                },
                                color: '#fff',
                                fontSize: 12,
                                fontWeight: 'bold',
                                textBorderColor: '#000',
                                textBorderWidth: 2,
                                textShadowColor: '#000',
                                textShadowBlur: 5
                            },
                            itemStyle: {
                                color: colors[currentPinType],
                                shadowBlur: 10,
                                shadowColor: colors[currentPinType]
                            },
                            emphasis: {
                                label: {
                                    show: true
                                }
                            },
                            zlevel: 2
                        }
                    ]
                });
            });
            
            // 設置圖表選項
            if (!myChart) {
                myChart = echarts.init(document.getElementById('main'));
            }
            
            // 清除之前的圖表實例
            myChart.clear();
            
            try {
                // 顯示加載動畫
                myChart.showLoading('default', {
                    text: '正在加載地圖...',
                    color: '#4cbbff',
                    textColor: '#fff',
                    maskColor: 'rgba(0, 0, 0, 0.7)'
                });
                
                // 使用setTimeout確保DOM更新
                setTimeout(() => {
                    try {
                        // 設置圖表選項
                        myChart.setOption(optionXyMap01, true);
                        
                        // 隱藏加載動畫
                        myChart.hideLoading();
                        
                        // 觸發圖表重繪
                        myChart.dispatchAction({
                            type: 'highlight',
                            seriesIndex: 0,
                            dataIndex: 0
                        });
                        
                        // 自動調整大小
                        const resizeHandler = function() {
                            myChart && myChart.resize();
                        };
                        
                        // 移除之前的事件監聽器
                        window.removeEventListener('resize', resizeHandler);
                        window.addEventListener('resize', resizeHandler);
                        
                        console.log('圖表渲染完成');
                    } catch (e) {
                        console.error('渲染圖表時出錯:', e);
                        myChart.hideLoading();
                        
                        // 顯示錯誤信息
                        const errorMsg = document.createElement('div');
                        errorMsg.style.position = 'absolute';
                        errorMsg.style.top = '50%';
                        errorMsg.style.left = '50%';
                        errorMsg.style.transform = 'translate(-50%, -50%)';
                        errorMsg.style.color = 'red';
                        errorMsg.style.fontSize = '16px';
                        errorMsg.style.textAlign = 'center';
                        errorMsg.innerHTML = `圖表渲染失敗: ${e.message || '未知錯誤'}`;
                        
                        const chartContainer = document.getElementById('main');
                        chartContainer.innerHTML = '';
                        chartContainer.appendChild(errorMsg);
                    }
                }, 100);
            } catch (e) {
                console.error('初始化圖表時出錯:', e);
                myChart.hideLoading();
            }
        }
    </script>
</body>
</html>
