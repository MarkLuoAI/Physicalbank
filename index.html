<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>實物銀行 服務數據統計</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<style>
    body {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-image: linear-gradient(45deg, #4b0082, #00005b, #000020);
  font-family: 'Montserrat', sans-serif;
}
</style>
<body>
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <h2>數據載入中，請稍候...</h2>
    </div>
    <div id="main" style="width: 100%; height: 100vh;"></div>
<script>
// Replace with your Google Apps Script URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-SSHDSGrmCV_ywvlXgrZelswb3mI80MNiddDAaibJ4qKfLPoTQ8BmPcXU9xhvyTrC/exec';

// Global variables
let chartDom, myChart, optionXyMap01;
const uploadedDataURL = "https://slimMay.github.io/storeTW/twCounty2010.json";
const colors = ["#ff0076", "#F46E36", "#04B9FF", "#5DBD32", "#FFC809", "#1DE9B6", "#BDA29A", "#6E7074", "#546570", "#C4CCD3"];
const year = ["2017", "2018", "2019", "2020", "2021", "2022", "2023", "2024"];
let currentPinType = 0;
let geoCoordMap = {};

// Data structures
let mapData = [[], [], [], [], [], [], [], []];
let pinData = [
    [[], [], [], [], [], [], [], []], // 受益戶數
    [[], [], [], [], [], [], [], []], // 受益人次
    [[], [], [], [], [], [], [], []]  // 受益同住人
];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

// Load data from Google Sheets
async function loadData() {
    try {
        showLoading();
        
        // Load data from Google Sheets
        const response = await fetch(GOOGLE_SCRIPT_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const sheetData = await response.json();
        
        // Process the data
        processData(sheetData);
        
        // Initialize the chart
        initChart();
        
        hideLoading();
    } catch (error) {
        console.error('Error loading data:', error);
        showError('數據載入失敗: ' + error.message);
    }
}

// Process data from Google Sheets
function processData(data) {
    // Reset data structures
    geoCoordMap = {};
    mapData = [[], [], [], [], [], [], [], []];
    pinData = [
        [[], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], []]
    ];
    
    // Process each row from the sheet
    data.forEach(row => {
        const city = row['城市'];
        if (!city) return;
        
        // Store coordinates
        if (row['經度'] && row['緯度']) {
            geoCoordMap[city] = [parseFloat(row['經度']), parseFloat(row['緯度'])];
        }
        
        // Process data for each year (2017-2024)
        for (let y = 0; y < 8; y++) {
            const currentYear = 2017 + y;
            
            // Map data (核定金額)
            const amount = parseFloat(row[`${currentYear}_核定金額`]) || 0;
            mapData[y].push({
                year: currentYear.toString(),
                name: city,
                value: amount
            });
            
            // Pin data (受益戶數, 受益人次, 受益同住人)
            const pinTypes = ['受益戶數', '受益人次', '受益同住人'];
            for (let p = 0; p < 3; p++) {
                let value = 0;
                if (p === 0) {
                    value = parseInt(row[`${currentYear}_${pinTypes[p]}`]) || 0;
                } else if (p === 1 && y < 4) { // 受益人次 only has data for 2017-2020
                    value = parseInt(row[`${currentYear}_${pinTypes[p]}`]) || 0;
                } else if (p === 2 && y < 4) { // 受益同住人 only has data for 2017-2020
                    value = parseInt(row[`${currentYear}_${pinTypes[p]}`]) || 0;
                }
                
                pinData[p][y].push({
                    year: currentYear.toString(),
                    name: city,
                    value: value
                });
            }
        }
    });
    
    // Add Taiwan total
    geoCoordMap['全台'] = [121.944845, 22.542893];
    
    // Calculate totals for each year
    for (let y = 0; y < 8; y++) {
        // Calculate total amount
        const totalAmount = mapData[y].reduce((sum, item) => sum + item.value, 0);
        mapData[y].push({
            year: (2017 + y).toString(),
            name: '全台',
            value: totalAmount
        });
        
        // Calculate total for 受益戶數
        const totalBeneficiaries = pinData[0][y].reduce((sum, item) => sum + item.value, 0);
        pinData[0][y].push({
            year: (2017 + y).toString(),
            name: '全台',
            value: totalBeneficiaries
        });
    }
}

// Initialize the chart
function initChart() {
    chartDom = document.getElementById("main");
    myChart = echarts.init(chartDom);
    
    // Load map data
    $.getJSON(uploadedDataURL, function(geoJson) {
        echarts.registerMap('TW', geoJson);
        
        // Prepare chart options
        prepareChartOptions();
        
        // Set the chart options
        myChart.setOption(optionXyMap01);
        
        // Add window resize listener
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    });
}

// Prepare chart options
function prepareChartOptions() {
    // Sort data for each year
    const sortedMapData = mapData.map(yearData => 
        [...yearData].sort((a, b) => a.value - b.value)
    );
    
    const sortedPinData = pinData.map(pinType => 
        pinType.map(yearData => 
            [...yearData].sort((a, b) => a.value - b.value)
        )
    );
    
    // Prepare bar data
    const barData = sortedMapData.map(yearData => 
        yearData.map(item => item.value)
    );
    
    const categoryData = sortedMapData.map(yearData => 
        yearData.map(item => item.name)
    );
    
    optionXyMap01 = {
        // ... (keep the existing timeline and baseOption configuration)
        // ... (keep the existing chart configuration)
        // ... (update the data binding parts to use the processed data)
    };
    
    // Add the switchPinType function
    window.switchPinType = function(type) {
        currentPinType = type;
        if (myChart && optionXyMap01) {
            // Update the chart with new pin type
            updateChartForPinType();
        }
    };
    
    // Add UI controls
    addPinTypeControls();
}

// Helper functions
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showError(message) {
    const loadingEl = document.getElementById('loading');
    loadingEl.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <h2>數據載入失敗</h2>
            <p>${message}</p>
            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2B91B7; color: white; border: none; border-radius: 5px; cursor: pointer;">
                重新載入
            </button>
        </div>`;
}

// Add pin type control buttons
function addPinTypeControls() {
    const pinTypeTitles = ["受益戶數", "受益人次", "受益同住人"];
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '10px';
    container.style.bottom = '50px';
    container.style.zIndex = '999';

    pinTypeTitles.forEach((title, index) => {
        const button = document.createElement('button');
        button.textContent = title;
        button.style.margin = '5px';
        button.style.padding = '5px 10px';
        button.style.backgroundColor = index === currentPinType ? colors[index] : '#2B91B7';
        button.style.color = '#fff';
        button.style.border = 'none';
        button.style.borderRadius = '3px';
        button.style.cursor = 'pointer';
        
        button.onclick = () => switchPinType(index);
        container.appendChild(button);
    });

    // Remove existing controls if any
    const existingContainer = document.querySelector('.pin-type-controls');
    if (existingContainer) {
        existingContainer.remove();
    }
    
    container.className = 'pin-type-controls';
    document.body.appendChild(container);
}

// Update chart when pin type changes
function updateChartForPinType() {
    // Update the chart options for the current pin type
    // This would involve updating the relevant series in optionXyMap01
    // and then calling myChart.setOption(optionXyMap01);
    
    // Update button styles
    document.querySelectorAll('.pin-type-controls button').forEach((btn, index) => {
        btn.style.backgroundColor = index === currentPinType ? colors[index] : '#2B91B7';
    });
    
    // Force chart update
    myChart.setOption(optionXyMap01, true);
}
</script>
</body>
</html>
